<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/ipfs-upload/ipfs-upload.html">

<script src="crypto-aes.js"></script>

<dom-module id="alabs-localstorageapi">
  <template>
    <ipfs-upload hidefileinput id="ipfsupload" host="/ip4/109.123.70.141/tcp/5001" ipfs="{{ipfs}}">

    <iron-localstorage 
      id="localstorage" 
      name="alabs-data" value="{{encdata}}" 
      on-iron-localstorage-load-empty="initEmpty">
    </iron-localstorage>

    <iron-localstorage 
      id="localstorage" 
      name="ipfs-hash" value="{{ipfshash}}">
    </iron-localstorage>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'alabs-localstorageapi',

      properties: {

      data: {
        type: Object,
        notify: true,
        observer: "_dataChanged"
      },

      publickey: {
        type: String,
        observer: "_publickey"
      },

      privatekey: {
        type: String,
        observer: "_privatekey"
      },

      encdata: {
        type: String,
        notify: true,
        observer: "_encdataChanged"
      },

      ipfshash: {
        type: String,
        notify: true
      }

    },

    _privatekey: function(){
      //console.log(this.privatekey);
    },

    _publickey: function(){
      //console.log(this.publickey);
    },

    initEmpty: function(){
      //lomqtt = document.querySelector("lo-mqtt");
      console.log("Init activated");
      // lomqtt.subscribe('userobject/'+this.publickey, 2, function(e){
      //   console.log("Init data: ",e);
      // });
      var data = { testfield: '', lastupdate: Date.now() };
      this.data = data;
      this.fire('init-data');
      this.writeData();
      //data written
    },

    writeData: function(){
        //lomqtt = document.querySelector("lo-mqtt");
        var self = this;
        //console.log("Pincode:", this.privatekey);
        var privatekey = this.privatekey;
        //console.log('Localstorage API write: ', this.data);
        var object = this.data;
        var stringifiedobject = JSON.stringify(object);
        //console.log(stringifiedobject);
        var encrypted = CryptoJS.AES.encrypt(stringifiedobject, privatekey);
        //console.log('Localstorage API encrypted: ',encrypted.toString());
        this.encdata = encrypted.toString();
        //lomqtt.send(this.publickey, this.encdata);
        this.savetoipfs(this.encdata, function(e){
          self.ipfshash = e;
        });
        //lomqtt.send('userobject/'+this.publickey, "USERUPDATE|"+this.encdata, 0);
        //var peers = this.data.peers;
        //this.$.loxmpp.sendgroupMessage(this.publickey, "SYNCUPDATE", null, null, this.encdata);
        // for (var i = peers.length - 1; i >= 0; i--) {
        //   if(peers[i]!=this.deviceid+"@opantwerpen.be"){
        //     console.log('Save ook bij: ',peers[i]);
        //     this.$.loxmpp.sendMessage(peers[i], "SYNCUPDATE", null, null, this.encdata);
        //   };
        // };
        this.readData();
    },

    readData: function(){
      var self = this;
      if(!this.encdata){
        this.initEmpty();
      } else {
        var privatekey = this.privatekey;
        //console.log("getting this from ipfs: ", 
          //this.ipfs.cat("QmW5kqnBkceCAbLNN9cD8Vn6Dy2nvvxQ4kDN5xqSUvjpcF", function(err, buffer) {
  //if (err) throw err;
 // console.log(JSON.stringify(buffer));   // "Testing..."
//}));
          // this.ipfs.cat(this.ipfshash, function(err, res){
          //   console.log(self.ipfs.Buffer(res).toArrayBuffer());
          // }));
        var decrypted = CryptoJS.AES.decrypt(this.encdata, privatekey);
        var decrtostring = decrypted.toString(CryptoJS.enc.Utf8);
        var data = JSON.parse(decrtostring, function(k, v) {
          return v;       // return the unchanged property value.
        });
        this.data = data;
        console.log(JSON.stringify(data));
      };
    },

    _encdataChanged: function(){
      this.readData();
    },

    _dataChanged: function(){
      this.fire("data-changed");
    },

    getipfs: function(){
      this.ipfs.name.resolve('QmYprJFf6tUJoVzCobG6BuAtnyz4NcSAMst9nD6mkrnxUX',function(err, res) {
        if (err || !res) return console.error(err)
        console.log('got something from IPNS', res);
    });

    },

    storeipns: function(){
      this.ipfs.name.publish('/ipfs/QmW5kqnBkceCAbLNN9cD8Vn6Dy2nvvxQ4kDN5xqSUvjpcF', function(err, res) {
        if (err || !res) return console.error(err)
        console.log('got something from IPNS', res);
    });s
    },

    savetoipfs: function(ipfsbuffer, fn){
      var ipfsbuffer = JSON.stringify(ipfsbuffer);
      console.log(ipfsbuffer);
      this.ipfs.add([new this.ipfs.Buffer(ipfsbuffer)], function(err, res) {
        if (err || !res) return console.error(err)
        console.log('added to IPFS');
        console.log(res[0].Hash);
        fn(res[0].Hash);
      });
    }

    });
  })();
  </script>
</dom-module>
