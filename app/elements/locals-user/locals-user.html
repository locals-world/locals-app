<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../bower_components/web3-wallet/web3-wallet.html">
<link rel="import" href="../../bower_components/ipfs-upload/ipfs-upload.html">

<link rel="import" href="../../bower_components/locals-avatar/locals-avatar.html">
<link rel="import" href="../../bower_components/locals-button/locals-button.html">
<link rel="import" href="../../bower_components/locals-lsapi/locals-lsapi.html">
<link rel="import" href="../../bower_components/locals-icon/locals-icon.html">
<link rel="import" href="../../bower_components/locals-scroller/locals-scroller.html">
<link rel="import" href="../../bower_components/locals-store/locals-store.html">
<link rel="import" href="../../bower_components/locals-style/locals-style.html">
<link rel="import" href="../../bower_components/locals-whisperer/locals-whisperer.html">

<dom-module id="locals-user">
  <template>
    <style>
      :host {
        display: block;
        --topbar-height: 100px;
        --scrollarea-height: 800px;
        --bg-size: auto 800px;
        --scrollarea-padding: 200px 0px 0px 0px;
      }

      p {
        @apply(--locals-font-body1);
        @apply(--opensans-semibold);
      }



      .topbar {
        width: 100%;
        height: var(--topbar-height);
        background-color: #a8daf0;
        @apply(--layout-horizontal);
        @apply(--layout-center);
/*        @apply(--layout-end-justified); */
        box-sizing: border-box;
        padding: 10px 20px 10px 10px;
        }

      .scrollarea {
        width: 100%;
        min-height: var(--scrollarea-height);
        background: url(../../images/locals-bg.png);
        background-size: var(--bg-size);
        background-repeat: repeat-x;
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        box-sizing: border-box;
        padding: var(--scrollarea-padding);
      }

      .flex {
        @apply(--layout-horizontal);
        @apply(--layout-flex);
      }

      #storebtn {
        z-index: 11;

      }

      .balance {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }



      locals-store {
        width: 100%;
        height: 100%;
        @apply(--layout-fit);
        z-index: 10;
      }

      .menuicon {
        cursor: pointer;
        height: 60px;
        width: 60px;
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
      }

      .normal {
        transition: all .05s linear;
        transform: rotate(0deg);
        -ms-transform: rotate(0deg);
        -webkit-transform: rotate(0deg);
      }

      .kruis {
        transition: all .05s linear;
        transform: rotate(45deg);
        -ms-transform: rotate(45deg);
        -webkit-transform: rotate(45deg);
      }
/*      paper-drawer-panel {
        height: 100%;
      }*/

     .main {
      overflow-y: scroll;
     }

      ::-webkit-scrollbar { 
          display: none; 
      }

     .drawer {
      background-color: var(--locals-darkgrey);
      box-sizing: border-box;
      padding: 50px;
      color: white;
     }

    </style>

    <iron-localstorage 
      name="locals-password" 
      value="{{passwd}}"></iron-localstorage>

    <ipfs-upload 
      id="ipfsupload" 
      hash="" 
      on-ipfs-hash-received="" 
      on-upload-started="" 
      on-upload-error="" 
      host="/ip4/109.123.70.141/tcp/5001"
      hidefileinput></ipfs-upload>

    <web3-wallet 
      id="web3wallet"
      walletname="locals-wallet"
      password="{{passwd}}" 
      account="{{account}}" 
      balance="{{balance}}" 
      keystore="{{keystore}}" 
      host="http://109.123.70.141:8545"
      web3="{{web3}}"></web3-wallet>

    <locals-lsapi verbose id="lsapi" privatekey="{{passwd}}" data="{{data}}"></locals-lsapi>

    <flatiron-director route="{{route}}" autoHash></flatiron-director>

    <!--     <div>
    Your account:
    <span>{{fixedaddress}}</span>
  </div>
  <div>
    Your Eth balance:
    <span>{{ethbalans}}</span>
  </div>
  <div>
    Your Localcoin balance:
    <span>{{locbalans}}</span>
  </div>

  <template is="dom-if" if="{{nolocalcoin}}">
    <h1>You don't have LocalCoin.</h1>
    <p>Ask LocalTokenAdmin to get you some.</p>
    <p> <i>"can i haz localtokens on this address
        <span>{{fixedaddress}}</span>
        ?"</i> 
    </p>
  </template>
  -->
  <!--     <template is="dom-if" if="{{!nolocalcoin}}">
  <h1>You have LocalCoin.</h1>
  <p>So you can backup!</p>
  <paper-button raised on-tap="backup"></paper-button>
</template>
-->
<iron-media-query query="(min-width:0px) and (max-width: 600px)" query-matches="{{phoneview}}"></iron-media-query>
<iron-media-query query="(min-width:601px) and (max-width: 1280px)" query-matches="{{desktopview}}"></iron-media-query>
<iron-media-query query="(min-width:1281px)" query-matches="{{xlargeview}}"></iron-media-query>

<paper-drawer-panel force-narrow>
  <div drawer class="drawer">
    <div class="balance">
      <locals-icon small icon="ether" iconcolor="white"></locals-icon><p><span>{{ethbalans}}</span></p>
    </div>
    <div class="balance">
      <locals-icon small icon="localcoin" iconcolor="white"></locals-icon><p><span>{{locbalans}}</span></p>
    </div>
    <locals-whisperer web3="{{web3}}" id="whisper" on-msg-received="processMsg"></locals-whisperer>
  </div>

  <div main class="main">
  DE ROUTE IS {{route}}
  <neon-animated-pages selected="{{route}}" attr-for-selected="route">
    <neon-animatable route="">
    <div class="topbar">
      <div class="menuicon">
        <locals-icon icon="menu" iconcolor="darkgrey" paper-drawer-toggle></locals-icon>
      </div>
      <p class="flex"></p>
      <locals-button id="storebtn" icon="plus" on-tap="toggleStore" class$="{{storebtnclass}}"></locals-button>
    </div>
    <div class="scrollarea">
      <locals-scroller objects="{{data.collection}}" route="{{route}}"></locals-scroller>
    </div>
  </neon-animatable>

   <neon-animatable route="objectdetail">
   De objectdetail hier
        <!-- ZO WERKTE DIE IN SCROLLER -->
       <locals-objectrender on-tap="gotoEdit" key="{{selecteditem.key}}" objectdata="{{selecteditem.data}}" class="objectrender"></locals-objectrender>
  </neon-animatable>


   <neon-animatable route="store">
   DE STOOR
      <locals-store hidden="{{hidestore}}"></locals-store>
  </neon-animatable>
  </neon-animated-pages>

</div>
</paper-drawer-panel>

</template>
<script>
  (function() {
    'use strict';

    Polymer({
      is: 'locals-user',

      properties: {
        web3: {
          type: Object,
          notify: true,
          observer: '_web3'
        },

        account: {
          type: String,
          observer: '_account'
        },

        balans: {
          type: Number, 
          observer: '_balans'
        },

        tokenaddr: {
          type: String,
          value: '0xFf08F6E967a92F2A33f03e4ce206C479B9b706F3'
        },

        localsuseraddr: {
          type: String,
          value: '0x583E5cBf7808CCD36C3697FC0E1772634D9a60ee'
        },

        keystore: {
          type: Object,
          observer: '_keystore'
        },

        data: {
          observer: '_data'
        },

        localuserabi: {
          type: Object,
          value: [ { "constant": true, "inputs": [ { "name": "", "type": "address" } ], "name": "Ipfshash", "outputs": [ { "name": "", "type": "string", "value": "" } ], "type": "function" }, { "constant": false, "inputs": [ { "name": "_ipfshash", "type": "string" } ], "name": "addLocalsuser", "outputs": [], "type": "function" }, { "inputs": [], "type": "constructor" } ]
        },

        tokenabi: {
          type: Object,
          value: [ { "constant": true, "inputs": [], "name": "name", "outputs": [ { "name": "", "type": "string", "value": "LocalCoin" } ], "type": "function" }, { "constant": true, "inputs": [], "name": "totalSupply", "outputs": [ { "name": "", "type": "uint256", "value": "10000" } ], "type": "function" }, { "constant": false, "inputs": [ { "name": "_from", "type": "address" }, { "name": "_to", "type": "address" }, { "name": "_value", "type": "uint256" } ], "name": "transferFrom", "outputs": [ { "name": "success", "type": "bool" } ], "type": "function" }, { "constant": true, "inputs": [], "name": "decimals", "outputs": [ { "name": "", "type": "uint8", "value": "2" } ], "type": "function" }, { "constant": false, "inputs": [], "name": "kill", "outputs": [], "type": "function" }, { "constant": true, "inputs": [], "name": "version", "outputs": [ { "name": "", "type": "string", "value": "0.13" } ], "type": "function" }, { "constant": true, "inputs": [ { "name": "", "type": "address" } ], "name": "balanceOf", "outputs": [ { "name": "", "type": "uint256", "value": "0" } ], "type": "function" }, { "constant": false, "inputs": [ { "name": "target", "type": "address" }, { "name": "mintedAmount", "type": "uint256" } ], "name": "mintToken", "outputs": [], "type": "function" }, { "constant": true, "inputs": [], "name": "owner", "outputs": [ { "name": "", "type": "address", "value": "0x03f3be66f4dca6e7f5c15bd4950d78f66709ea44" } ], "type": "function" }, { "constant": true, "inputs": [], "name": "symbol", "outputs": [ { "name": "", "type": "string", "value": "Δ" } ], "type": "function" }, { "constant": false, "inputs": [ { "name": "_ethaccount", "type": "address" } ], "name": "checkEthBalance", "outputs": [], "type": "function" }, { "constant": true, "inputs": [], "name": "minEthbalance", "outputs": [ { "name": "", "type": "uint256", "value": "50000000000000000" } ], "type": "function" }, { "constant": false, "inputs": [ { "name": "_to", "type": "address" }, { "name": "_value", "type": "uint256" } ], "name": "transfer", "outputs": [], "type": "function" }, { "constant": false, "inputs": [ { "name": "_spender", "type": "address" }, { "name": "_value", "type": "uint256" }, { "name": "_extraData", "type": "bytes" } ], "name": "approveAndCall", "outputs": [ { "name": "success", "type": "bool" } ], "type": "function" }, { "constant": true, "inputs": [ { "name": "", "type": "address" }, { "name": "", "type": "address" } ], "name": "spentAllowance", "outputs": [ { "name": "", "type": "uint256", "value": "0" } ], "type": "function" }, { "constant": true, "inputs": [ { "name": "", "type": "address" }, { "name": "", "type": "address" } ], "name": "allowance", "outputs": [ { "name": "", "type": "uint256", "value": "0" } ], "type": "function" }, { "constant": false, "inputs": [ { "name": "newOwner", "type": "address" } ], "name": "transferOwnership", "outputs": [], "type": "function" }, { "inputs": [ { "name": "initialSupply", "type": "uint256", "index": 0, "typeShort": "uint", "bits": "256", "displayName": "initial Supply", "template": "elements_input_uint", "value": "10000" }, { "name": "tokenName", "type": "string", "index": 1, "typeShort": "string", "bits": "", "displayName": "token Name", "template": "elements_input_string", "value": "LocalCoin" }, { "name": "decimalUnits", "type": "uint8", "index": 2, "typeShort": "uint", "bits": "8", "displayName": "decimal Units", "template": "elements_input_uint", "value": "2" }, { "name": "_minEthbalance", "type": "uint256", "index": 3, "typeShort": "uint", "bits": "256", "displayName": "&thinsp;<span class=\"punctuation\">_</span>&thinsp;min Ethbalance", "template": "elements_input_uint", "value": "50000000000000000" }, { "name": "tokenSymbol", "type": "string", "index": 4, "typeShort": "string", "bits": "", "displayName": "token Symbol", "template": "elements_input_string", "value": "Δ" }, { "name": "versionOfTheCode", "type": "string", "index": 5, "typeShort": "string", "bits": "", "displayName": "version Of The Code", "template": "elements_input_string", "value": "0.13" } ], "type": "constructor" }, { "anonymous": false, "inputs": [ { "indexed": true, "name": "from", "type": "address" }, { "indexed": true, "name": "to", "type": "address" }, { "indexed": false, "name": "value", "type": "uint256" } ], "name": "Transfer", "type": "event" } ]
        },

        phoneview: {
          type: Boolean,
          observer: '_sizeview'
        },

        desktopview: {
          type: Boolean,
          observer: '_sizeview'
        },

        xlargeview: {
          type: Boolean,
          observer: '_sizeview'
        },
      },

      ready: function(){
        this.nolocalcoin = true;
        this.hidestore = true;
        this.storeicon = 'plus';
        this.validations = {};
      },

      test: function(e){
        console.log(e);
      },


      _account: function(){
        this.fixedaddress = this.fixaddress(this.account);
      },

      _web3: function(){
        this.balans = this.$.web3wallet.updateBalance();
        this.getLocalbalance();
      },

      saveData: function(e){
        console.log('data changed: ',e, this.data);
        //this.$.lsapi.data.collection['locals-avatar'] = { data: e.detail.data, config: e.detail.config };
        //this.$.lsapi.writeData();
      },

      getLocalbalance: function(){
        //Get Localcoin token balance
        var MyCoinContract = this.web3.eth.contract(this.tokenabi);
        var myCoinContractInstance = MyCoinContract.at(this.tokenaddr);
        var account = this.fixaddress(this.account);
        var coinbalance = myCoinContractInstance.balanceOf(account).toNumber();
        this.locbalans = coinbalance / 100;
        if(coinbalance > 0){
          this.nolocalcoin = false;
        };
      },

      _data: function(){
        // console.log('has data: ',this.data);
        // this.avatardata = this.data.collection['locals-avatar'].data;
        // this.avatarconfig = this.data.collection['locals-avatar'].config;
        // console.log(JSON.stringify(this.avatarconfig));
      },

      _balans: function(){
        this.ethbalans = this.balans / 1e18;
      },

      _keystore: function(){
        var self = this;
        var keystore = this.keystore;
        lightwallet.keystore.deriveKeyFromPassword(self.passwd, function(err, pwDerivedKey) {
          console.log('account: ', self.account);
          console.log(keystore.exportPrivateKey(self.account, pwDerivedKey));
        });
      },

      transactionlog: function(e){
        console.log(e);
      },

      backup: function(){
        var self = this;
        this.$.ipfsupload.add(JSON.stringify(this.keystore), function(err, res) {
          if (!err && res[0] && res[0].Hash) {
            console.log(res[0].Hash);
            var hash = res[0].Hash;
            var myuserContract = self.web3.eth.contract(self.localuserabi);
            var myuserContractInstance = myuserContract.at(self.localsuseraddr);

            self.web3.eth.getGasPrice(function(err, result) {

              var gasPrice = result.toNumber(10);
              self.transactionlog('gas price: ', gasPrice);

              var options = {
                from: self.fixaddress(self.account),
                //value: 1 * 1e18,
                gas: 200000,
                gasPrice: gasPrice,
                nonce: new Date().getTime(),
              };

              self.transactionlog('Saving IPFS hash');
              self.pageselected = 2;

              var result = myuserContractInstance.addLocalsuser.sendTransaction(hash, options,
                function(err, txhash) {
                  if (err != null) {
                    console.log(err);
                    self.transactionlog('ERROR: Transaction didnt go through. See console.');
                  } else {
                    self.transactionlog('Transaction success: ', txhash);
                    console.log('Tx hash=', txhash);
                    // this triggers the locals-contractlistener component
                    self.txhash = txhash;
                  }

                  self.transactionlog('Your IPFS Hash has been added to the blockchain');
                });
            });
          };
        });
      },

      fixaddress: function(address) {
        function strStartsWith(str, prefix) {
          return str.indexOf(prefix) === 0;
        }

        if (!strStartsWith(address, '0x')) {
          return ('0x' + address);
        }
        return address;
      },


      _sizeview: function(){
        if (this.phoneview) {
          this.customStyle['--topbar-height'] = '100px';
          this.customStyle['--scrollarea-height'] = '320px';
          this.customStyle['--scrollarea-padding'] = '0px 0px 0px 0px';
          this.customStyle['--bg-size'] = 'auto 320px';
          this.updateStyles();
        }
        if (this.desktopview) {
          this.customStyle['--topbar-height'] = '100px';
          this.customStyle['--scrollarea-height'] = '490px';
          this.customStyle['--scrollarea-padding'] = '48px 0px 0px 0px';
          this.customStyle['--bg-size'] = 'auto 490px';
          this.updateStyles();
        }
        if (this.xlargeview) {
          this.customStyle['--topbar-height'] = '100px';
          this.customStyle['--scrollarea-height'] = '600px';
          this.customStyle['--scrollarea-padding'] = '50px 0px 0px 0px';
          this.customStyle['--bg-size'] = 'auto 600px';
          this.updateStyles();
        }

      },

      toggleStore: function(){
        this.hidestore=!this.hidestore;
        if(this.hidestore){
          this.storebtnclass = 'normal';
        } else {
          this.storebtnclass = 'kruis';
        }
        this.route = "store";
      },



      processMsg: function(e){
        console.log('incoming whisper msg: ', e.detail);

        var input = JSON.parse(e.detail.input)

        switch (input.command){
          case "senduserrequest":
            console.log('create AES key and send it to other party', input.data);

            var crypt = new JSEncrypt({
              default_key_size: 512
            });
            crypt.setPublicKey(input.data.pubkey);

            var aeskey = generateKey(50);
            this.validations[input.from] = {
              easkey: aeskey,
              pubkey:input.data.pubkey
            };

            var encryptedkey = crypt.encrypt(aeskey);

            this.$.whisper.whisperpost(input.from, JSON.stringify({
              command: 'sendaeskey',
              from: this.$.whisper.topic,
              data: encryptedkey
            }));

            break;
          case "senduserdata" :

var easKey = this.validations[input.from].easkey;

          var decryptedAvatar = CryptoJS.AES.decrypt(input.data,easKey);

            console.log('show data + validate',decryptedAvatar);
            break;

          default:
            //console.log('discard message',e.detail);
            break;

        }        


        // define the characters to pick from
       
        // create a key for symmetric encryption
        // pass in the desired length of your key
        function generateKey(keyLength){
           var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz*&-%/!?*+=()";
          var randomstring = '';
          
          for (var i=0; i < keyLength; i++) {
            var rnum = Math.floor(Math.random() * chars.length);
            randomstring += chars.substring(rnum,rnum+1);
          }
          return randomstring;
        };








      }

    });
  })();
  </script></dom-module>