<!--
@license
Copyright (c) 2016 A-labs. All rights reserved.
/////////////////
LOCALS
/////////////////
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<!-- <link rel="import" href="../../bower_components/paper-button/paper-button.html">
-->
<link rel="import" href="../../bower_components/web3-wallet/web3-wallet.html">
<link rel="import" href="../../bower_components/ipfs-upload/ipfs-upload.html">

<link rel="import" href="../../bower_components/locals-avatar/locals-avatar.html">
<link rel="import" href="../../bower_components/locals-button/locals-button.html">
<link rel="import" href="../../bower_components/locals-lsapi/locals-lsapi.html">
<link rel="import" href="../../bower_components/locals-icon/locals-icon.html">
<link rel="import" href="../../bower_components/locals-scroller/locals-scroller.html">
<link rel="import" href="../../bower_components/locals-store/locals-store.html">
<link rel="import" href="../../bower_components/locals-style/locals-style.html">
<!-- <link rel="import" href="../../bower_components/locals-verification/locals-verification.html"> -->
<link rel="import" href="../../bower_components/locals-verification/locals-verification-handler.html">

<link rel="import" href="locals-home.html">
<link rel="import" href="locals-detail.html">

<dom-module id="locals-user">
  <template>
    <style>
      :host {
        display: block;
      }

      h1 {
        @apply(--locals-font-h1);
      }

      p {
        @apply(--locals-font-body1);
        @apply(--opensans-semibold);
      }

      a {
        @apply(--locals-font-body1);
        @apply(--opensans-semibold);
        color:var(--locals-blue);
        text-decoration: none;
        outline: none;
        font-size: 12px;
        border-bottom: 1px dashed var(--locals-blue);        

      }

/*      .detailslink {
        border-bottom: 1px dashed var(--locals-blue);        
      }*/

      neon-animated-pages {
        height: 100%;
      }

      .balance {
        color: var(--locals-grey5);
        @apply(--layout-horizontal);
        @apply(--layout-end);
        @apply(--layout-wrap);
        /*margin: 0px 0px 6px 4px;*/
      }

      .balance:hover {
        cursor: pointer;
      }
      .balance h1 {
        margin: 0px;
      }

     .main {
      overflow-y: scroll;
        height: 100%;
        
     }

      ::-webkit-scrollbar { 
          display: none; 
      }

     .drawer {
      background-color: var(--locals-darkgrey);
      box-sizing: border-box;
      color: white;
     }

     .drawerpart {
      width: 100%;
      box-sizing: border-box;
      padding: 40px 50px 40px 50px;
      border-bottom:1px solid #404040;
      @apply(--layout-vertical);
      @apply(--layout-start);      
     }

     .canvas {
      @apply(--locals-canvas);
      height: 100vh;
      @apply(--layout-vertical);
      @apply(--layout-center-center);
     }

     .enterpass {
      width: 100%;
      max-width: 500px;
      @apply(--layout-vertical);
      @apply(--layout-center-center);
     }

     .localcoinamount {
      margin: 0px 0px 7px 6px;
     }

     .whitespace {
      height: 20px;
     }

     .refresher {
       -webkit-animation-name: rotate; 
      -webkit-animation-duration: 1s; 
      -webkit-animation-iteration-count: infinite;
      -webkit-animation-timing-function: linear;
      -moz-animation-name: rotate; 
      -moz-animation-duration: 1s; 
      -moz-animation-iteration-count: infinite;
      -moz-animation-timing-function: linear;
      animation-name: rotate; 
      animation-duration: 1s; 
      animation-iteration-count: infinite;
      animation-timing-function: linear;
     }

      @-webkit-keyframes rotate {
          from {-webkit-transform: rotate(0deg);}
          to {-webkit-transform: rotate(360deg);}
      }

      @-moz-keyframes rotate {
          from {-moz-transform: rotate(0deg);}
          to {-moz-transform: rotate(360deg);}
      }

      @keyframes rotate {
          from {transform: rotate(0deg);}
          to {transform: rotate(360deg);}
      }

    </style>

    <!-- <iron-localstorage 
      name="locals-password" 
      value="{{passwd}}"></iron-localstorage>
  -->
  <ipfs-upload 
      id="ipfsupload" 
      hash="" 
      on-ipfs-hash-received="" 
      on-upload-started="" 
      on-upload-error="" 
      host="/ip4/109.123.70.141/tcp/5001"
      hidefileinput></ipfs-upload>

  <web3-wallet 
      id="web3wallet"
      walletname="locals-wallet"
      password="{{passwd}}" 
      account="{{account}}" 
      balance="{{balance}}" 
      keystore="{{keystore}}" 
      host="http://109.123.70.141:8545"
      web3="{{web3}}"></web3-wallet>

  <!-- re-used in sub components ( locals-verification, locals-verification ) -->
  <locals-whisperer
    web3="{{web3}}"
    topic="{{topic}}"
    progress="{{progress}}"
    decimals="5"
    id="whisper"></locals-whisperer>

  

  <locals-lsapi
    verbose id="lsapi"
    data="{{data}}" on-wrong-password="_wrongpassword" on-correct-password="_gotpassword"></locals-lsapi>

<iron-media-query query="(min-width:0px) and (max-width: 600px)" query-matches="{{phoneview}}"></iron-media-query>
<iron-media-query query="(min-width:601px) and (max-width: 1280px)" query-matches="{{desktopview}}"></iron-media-query>
<iron-media-query query="(min-width:1281px)" query-matches="{{xlargeview}}"></iron-media-query>

<paper-drawer-panel id="drawer" force-narrow drawer-width="280px">
<div drawer class="drawer">
  <div class="whitespace"></div>
  <div class="drawerpart">
    <div class="balance" on-tap="toWallet">

      <template is="dom-if" if="{{!balanceloaded}}">
        <locals-icon class="refresher" icon="refresh1" iconcolor="grey2"></locals-icon>
      </template>
      <template is="dom-if" if="{{balanceloaded}}">
      <h1>{{locbalans}}</h1>
      <locals-icon class="localcoinamount" small icon="localcoin" iconcolor="grey5"></locals-icon>
      </template>
    </div>
    <a href="/#/wallet" on-tap="toWallet" class="detailslink">balance details</a>
  </div>
  <!-- <div class="drawerpart">
    <locals-button txt small txtcolor="white" href="/#/backup">backup</locals-button>
  </div> -->
</div>

<div main class="main">

  <excess-route
    route="/:menu"
    menu="{{appMenu}}"    
  ></excess-route>

  <neon-animated-pages selected="{{appMenu}}" attr-for-selected="route">
    <!-- home -->
    <locals-home route="home" data="{{data}}" on-to-detail="toDetail" on-to-store="toStore" on-to-verification="toVerification" on-toggle-drawer="drawertoggle" sizeview="{{sizeview}}"></locals-home>
    
    <!-- object detail -->
    <locals-detail route="objectdetail" objectdata="{{selecteditem.data}}" key="{{selecteditem.key}}" renderstate="open" on-to-home="toHome" sizeview="{{sizeview}}"></locals-detail>

    <!-- store -->
    <neon-animatable route="store">
      The Store will come here
      <locals-store route="store" on-to-home="toHome" sizeview="{{sizeview}}" mode="home"></locals-store>
    </neon-animatable>

    <!-- login / unlock wallet -->
    <neon-animatable route="enterpass">
    <div class="canvas">
    <div class="enterpass">
      <locals-input label="password" type="password" bind-value="{{passwd}}" center></locals-input>
      <locals-button class="loginbtn" icon="arrowright" on-tap="setPass"></locals-button>
    </div>
    </div>
    </neon-animatable>

    <!-- backup your wallet -->
    <neon-animatable route="backup">
      <locals-backup></locals-backup>
    </neon-animatable>

    <!-- verification : verify someone else's validation -->    
    <locals-verification-validator route="verification" on-to-home="toHome" sizeview="{{sizeview}}" mode="list" topic="{{topic}}" progress="{{progress}}" web3="{{web3}}" account="{{account}}"></locals-verification-validator>

    <!-- wallet: transfer funds -->
    <locals-wallet topic="{{topic}}" on-to-home="toHome" route="wallet" web3="{{web3}}" ethbalance="{{ethbalans}}" localcoinbalance="{{locbalans}}" account="{{account}}" sizeview="{{sizeview}}" on-balance-loaded="balanceLoad"></locals-wallet>

  </neon-animated-pages>

</div>
</paper-drawer-panel>

</template>
<script>
  (function() {
    'use strict';

    Polymer({
      is: 'locals-user',

      properties: {
        web3: {
          type: Object,
          notify: true,
          observer: '_web3'
        },

        account: {
          type: String,
          observer: '_account'
        },

        balans: {
          type: Number, 
          observer: '_balans'
        },

        tokenaddr: {
          type: String,
          value: '0xFf08F6E967a92F2A33f03e4ce206C479B9b706F3'
        },

        localsuseraddr: {
          type: String
        },

        keystore: {
          type: Object,
          observer: '_keystore'
        },

        locbalans: {
          type: Number,
          value: '44',
          observer: '_locbalans'
        },

        data: {
          observer: '_data'
        },

        balanceloaded: {
          type: Boolean,
          value: false
        },

        localuserabi: {
          type: Object,
          value: [ { 'constant': true, 'inputs': [ { 'name': '', 'type': 'address' } ], 'name': 'Ipfshash', 'outputs': [ { 'name': '', 'type': 'string', 'value': '' } ], 'type': 'function' }, { 'constant': false, 'inputs': [ { 'name': '_ipfshash', 'type': 'string' } ], 'name': 'addLocalsuser', 'outputs': [], 'type': 'function' }, { 'inputs': [], 'type': 'constructor' } ]
        },

        tokenabi: {
          type: Object,
          value: [ { 'constant': true, 'inputs': [], 'name': 'name', 'outputs': [ { 'name': '', 'type': 'string', 'value': 'LocalCoin' } ], 'type': 'function' }, { 'constant': true, 'inputs': [], 'name': 'totalSupply', 'outputs': [ { 'name': '', 'type': 'uint256', 'value': '10000' } ], 'type': 'function' }, { 'constant': false, 'inputs': [ { 'name': '_from', 'type': 'address' }, { 'name': '_to', 'type': 'address' }, { 'name': '_value', 'type': 'uint256' } ], 'name': 'transferFrom', 'outputs': [ { 'name': 'success', 'type': 'bool' } ], 'type': 'function' }, { 'constant': true, 'inputs': [], 'name': 'decimals', 'outputs': [ { 'name': '', 'type': 'uint8', 'value': '2' } ], 'type': 'function' }, { 'constant': false, 'inputs': [], 'name': 'kill', 'outputs': [], 'type': 'function' }, { 'constant': true, 'inputs': [], 'name': 'version', 'outputs': [ { 'name': '', 'type': 'string', 'value': '0.13' } ], 'type': 'function' }, { 'constant': true, 'inputs': [ { 'name': '', 'type': 'address' } ], 'name': 'balanceOf', 'outputs': [ { 'name': '', 'type': 'uint256', 'value': '0' } ], 'type': 'function' }, { 'constant': false, 'inputs': [ { 'name': 'target', 'type': 'address' }, { 'name': 'mintedAmount', 'type': 'uint256' } ], 'name': 'mintToken', 'outputs': [], 'type': 'function' }, { 'constant': true, 'inputs': [], 'name': 'owner', 'outputs': [ { 'name': '', 'type': 'address', 'value': '0x03f3be66f4dca6e7f5c15bd4950d78f66709ea44' } ], 'type': 'function' }, { 'constant': true, 'inputs': [], 'name': 'symbol', 'outputs': [ { 'name': '', 'type': 'string', 'value': 'Δ' } ], 'type': 'function' }, { 'constant': false, 'inputs': [ { 'name': '_ethaccount', 'type': 'address' } ], 'name': 'checkEthBalance', 'outputs': [], 'type': 'function' }, { 'constant': true, 'inputs': [], 'name': 'minEthbalance', 'outputs': [ { 'name': '', 'type': 'uint256', 'value': '50000000000000000' } ], 'type': 'function' }, { 'constant': false, 'inputs': [ { 'name': '_to', 'type': 'address' }, { 'name': '_value', 'type': 'uint256' } ], 'name': 'transfer', 'outputs': [], 'type': 'function' }, { 'constant': false, 'inputs': [ { 'name': '_spender', 'type': 'address' }, { 'name': '_value', 'type': 'uint256' }, { 'name': '_extraData', 'type': 'bytes' } ], 'name': 'approveAndCall', 'outputs': [ { 'name': 'success', 'type': 'bool' } ], 'type': 'function' }, { 'constant': true, 'inputs': [ { 'name': '', 'type': 'address' }, { 'name': '', 'type': 'address' } ], 'name': 'spentAllowance', 'outputs': [ { 'name': '', 'type': 'uint256', 'value': '0' } ], 'type': 'function' }, { 'constant': true, 'inputs': [ { 'name': '', 'type': 'address' }, { 'name': '', 'type': 'address' } ], 'name': 'allowance', 'outputs': [ { 'name': '', 'type': 'uint256', 'value': '0' } ], 'type': 'function' }, { 'constant': false, 'inputs': [ { 'name': 'newOwner', 'type': 'address' } ], 'name': 'transferOwnership', 'outputs': [], 'type': 'function' }, { 'inputs': [ { 'name': 'initialSupply', 'type': 'uint256', 'index': 0, 'typeShort': 'uint', 'bits': '256', 'displayName': 'initial Supply', 'template': 'elements_input_uint', 'value': '10000' }, { 'name': 'tokenName', 'type': 'string', 'index': 1, 'typeShort': 'string', 'bits': '', 'displayName': 'token Name', 'template': 'elements_input_string', 'value': 'LocalCoin' }, { 'name': 'decimalUnits', 'type': 'uint8', 'index': 2, 'typeShort': 'uint', 'bits': '8', 'displayName': 'decimal Units', 'template': 'elements_input_uint', 'value': '2' }, { 'name': '_minEthbalance', 'type': 'uint256', 'index': 3, 'typeShort': 'uint', 'bits': '256', 'displayName': '&thinsp;<span class=\'punctuation\'>_</span>&thinsp;min Ethbalance', 'template': 'elements_input_uint', 'value': '50000000000000000' }, { 'name': 'tokenSymbol', 'type': 'string', 'index': 4, 'typeShort': 'string', 'bits': '', 'displayName': 'token Symbol', 'template': 'elements_input_string', 'value': 'Δ' }, { 'name': 'versionOfTheCode', 'type': 'string', 'index': 5, 'typeShort': 'string', 'bits': '', 'displayName': 'version Of The Code', 'template': 'elements_input_string', 'value': '0.13' } ], 'type': 'constructor' }, { 'anonymous': false, 'inputs': [ { 'indexed': true, 'name': 'from', 'type': 'address' }, { 'indexed': true, 'name': 'to', 'type': 'address' }, { 'indexed': false, 'name': 'value', 'type': 'uint256' } ], 'name': 'Transfer', 'type': 'event' } ]
        },

        phoneview: {
          type: Boolean,
          observer: '_sizeview'
        },

        desktopview: {
          type: Boolean,
          observer: '_sizeview'
        },

        xlargeview: {
          type: Boolean,
          observer: '_sizeview'
        },
      },

      attached: function(){
        this.nolocalcoin = true;
        this.hidestore = true;
        this.storeicon = 'plus';
        this.validations = {};
        var passwd = sessionStorage.getItem("lopassword");
        if (passwd){
          this.passwd = passwd;
        }else{
          Excess.RouteManager.transitionTo('/enterpass');
        }
        // if(sessionStorage.getItem("lopassword")){
        //   this.passwd = sessionStorage.getItem("lopassword");
        //   Excess.RouteManager.transitionTo('/home');
        // } else {
        //   console.log('i need a passwd');
        //   Excess.RouteManager.transitionTo('/enterpass');
        // }
        //console.log(this.passwd);     
      },

      setPass: function(){
        //debugger;
        this.$.lsapi.privatekey = this.passwd;
      },

      _gotpassword: function(){
        //debugger;
        console.log('go home');
        sessionStorage.setItem('lopassword', this.passwd);
          Excess.RouteManager.transitionTo('/home');
      },

      _wrongpassword: function(){
        //sessionStorage.clearItem('lopassword');
          Excess.RouteManager.transitionTo('/enterpass');
      },

      test: function(e){
        console.log(e);
      },

      toDetail: function(e){
        // console.log('IN USER ******',e.detail.object);
        this.selecteditem = e.detail.object;
        Excess.RouteManager.transitionTo('/objectdetail');
      },

      toStore: function(){
        Excess.RouteManager.transitionTo('/store');
      },

      toHome: function(){
        Excess.RouteManager.transitionTo('/home');
      },

      toWallet: function(){
        Excess.RouteManager.transitionTo('/wallet');
        this.$.drawer.togglePanel();
      },

      toVerification: function(){
        Excess.RouteManager.transitionTo('/verification');
      },

      _account: function(){
        this.fixedaddress = this.fixaddress(this.account);
      },

      _web3: function(){
        this.balans = this.$.web3wallet.updateBalance();
        this.getLocalbalance();
      },

      saveData: function(e){
        console.log('data changed: ',e, this.data);
        //this.$.lsapi.data.collection['locals-avatar'] = { data: e.detail.data, config: e.detail.config };
        //this.$.lsapi.writeData();
      },



      getLocalbalance: function(){
        //Get Localcoin token balance
        var MyCoinContract = this.web3.eth.contract(this.tokenabi);
        var myCoinContractInstance = MyCoinContract.at(this.tokenaddr);
        var account = this.fixaddress(this.account);
        var coinbalance = myCoinContractInstance.balanceOf(account).toNumber();
        this.locbalans = coinbalance;
        if(coinbalance > 0){
          this.nolocalcoin = false;
        };
      },

      _data: function(){
        //this.setValidationshandler();
        // console.log('has data: ',this.data);
        // this.avatardata = this.data.collection['locals-avatar'].data;
        // this.avatarconfig = this.data.collection['locals-avatar'].config;
        // console.log(JSON.stringify(this.avatarconfig));
      },

      _balans: function(){
        this.ethbalans = this.balans / 1e18;
      },

      _keystore: function(){
        var self = this;
        var keystore = this.keystore;
        lightwallet.keystore.deriveKeyFromPassword(self.passwd, function(err, pwDerivedKey) {
          console.log('account: ', self.account);
          console.log(keystore.exportPrivateKey(self.account, pwDerivedKey));
        });
      },

      transactionlog: function(e){
        console.log(e);
      },

      backup: function(){
        var self = this;
        this.$.ipfsupload.add(JSON.stringify(this.keystore), function(err, res) {
          if (!err && res[0] && res[0].Hash) {
            console.log(res[0].Hash);
            var hash = res[0].Hash;
            var myuserContract = self.web3.eth.contract(self.localuserabi);
            var myuserContractInstance = myuserContract.at(self.localsuseraddr);

            self.web3.eth.getGasPrice(function(err, result) {

              var gasPrice = result.toNumber(10);
              self.transactionlog('gas price: ', gasPrice);

              var options = {
                from: self.fixaddress(self.account),
                //value: 1 * 1e18,
                gas: 200000,
                gasPrice: gasPrice,
                nonce: new Date().getTime(),
              };

              self.transactionlog('Saving IPFS hash');
              self.pageselected = 2;

              result = myuserContractInstance.addLocalsuser.sendTransaction(hash, options,
                function(err, txhash) {
                  if (err != null) {
                    console.log(err);
                    self.transactionlog('ERROR: Transaction didnt go through. See console.');
                  } else {
                    self.transactionlog('Transaction success: ', txhash);
                    console.log('Tx hash=', txhash);
                    // this triggers the locals-contractlistener component
                    self.txhash = txhash;
                  }

                  self.transactionlog('Your IPFS Hash has been added to the blockchain');
                });
            });
          };
        });
      },

      fixaddress: function(address) {
        function strStartsWith(str, prefix) {
          return str.indexOf(prefix) === 0;
        }

        if (!strStartsWith(address, '0x')) {
          return ('0x' + address);
        }
        return address;
      },


      _sizeview: function(){
        if (this.phoneview) {
          this.sizeview = 'phone';
        }
        if (this.desktopview) {
          this.sizeview = 'desktop';
        }
        if (this.xlargeview) {
          this.sizeview = 'xlarge';
        }

      },

      // toggleStore: function(){
      //   this.hidestore=!this.hidestore;
      //   if(this.hidestore){
      //     this.storebtnclass = 'normal';
      //   } else {
      //     this.storebtnclass = 'kruis';
      //   }
      //   this.route = "store";
      // },

    back: function(){
        Excess.RouteManager.transitionTo('/home');
    },

    drawertoggle: function() {
      this.$.drawer.togglePanel();
    },

    balanceLoad: function(){
      this.balanceloaded = true;
    },


    _locbalans: function(){
    }

    });
  })();
  </script>
</dom-module>