<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/locals-button/locals-button.html">
<link rel="import" href="../../bower_components/locals-icon/locals-icon.html">

<dom-module id="locals-wallet">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
/*        background-color: var(--locals-grey1);*/
        background-color: white;
        width: 100vw;
        --balance-h1: 40px;
        --balance-lineheight: 52px;
        --coin-margins: 0px 0px 7px 6px;
        --code-h2: 32px;
        --code-lineheight: 36px;
        --code-small: 10px;

      }

      h1 {
        @apply(--locals-font-h1);
        text-align: center;
        font-size: var(--balance-h1);
        line-height: var(--balance-lineheight);
      }


      h2 {
        @apply(--locals-font-h2);
        @apply(--opensans-semibold);
        font-size: var(--code-h2);
        line-height: var(--code-lineheight);
        color:var(--locals-blue);
      }

      p {
        @apply(--locals-font-body1);
      }

      small {
        @apply(--locals-font-small);
        @apply(--opensans-semibold);
        color:var(--locals-blue);
        font-size: var(--code-small);

      }


      .total {
        width: 100vw;
        /*background-color: var(--locals-grey1);*/
        @apply(--layout-vertical);
        @apply(--layout-start);
      }

      .totalpart {
        width: 100vw;
        box-sizing: border-box;
        padding: 0px 10vw 0px 10vw;
      }


      .topbar {
        width: 100%;
        background-color: transparent;
        height: var(--topbar-height);
        @apply(--layout-horizontal);
        @apply(--layout-center);
        box-sizing: border-box;
        padding: 10px 20px 10px 20px;
        }

      .flex {
        @apply(--layout-horizontal);
        @apply(--layout-flex);
      }


      .balance {
        color: var(--locals-darkgrey);
        @apply(--layout-horizontal);
        @apply(--layout-end);
        @apply(--layout-start-justified);
        @apply(--layout-wrap);
      }

       .balance h1 {
          margin: 0px;
        }

       .localcoinamount {
        margin: var(--coin-margins);
       }

      .tussenschot {
        width: 100%;
        border: 0;
        margin: 0px;
        color: var(--locals-grey3);
        background-color: var(--locals-grey2);
        height: 1px;
      }

      .inbutton {
        width: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-end);
      }

     .coinbtn {
      margin-left: 5px;
     }

     #sendcoins {
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
      @apply(--layout-vertical);
      @apply(--layout-center-center);
     }

     #receivecoins {
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
      @apply(--layout-horizontal);
      @apply(--layout-center);
      @apply(--layout-start-justified);
     }

     .announce {
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
/*      padding: 10px 0px 10px 0px;*/
      @apply(--layout-horizontal);
      @apply(--layout-center);
      @apply(--layout-start-justified);
      @apply(--layout-wrap);
     }


     .whitespace {
      height: 2vh;
     }

     .code {
      @apply(--layout-vertical);
      @apply(--layout-start);
      margin: 0px 20px 0px 0px;

     }

     .announce p {
      margin: 0px 20px 10px 0px;
     }

     .marginbtm {
      margin-left: 15px;
      margin: var(--coin-margins);
     }

     .temp {
      margin-top: 6vh;
      color: var(--locals-grey4);
     }

     .refresher {
        transition: all 1s linear;
     }


     .spinner {
      -webkit-animation: rotate 0.5s linear infinite;
      -moz-animation: rotate 0.5s linear infinite;
      animation: rotate 0.5s linear infinite;
     }


     .spinonce {
      -webkit-animation: rotate 0.5s linear infinite;
      -moz-animation: rotate 0.5s linear infinite;
      animation: rotate 0.5s linear infinite;

     }



      @-webkit-keyframes rotate {
          from {-webkit-transform: rotate(0deg);}
          to {-webkit-transform: rotate(180deg);}
      }

      @-moz-keyframes rotate {
          from {-moz-transform: rotate(0deg);}
          to {-moz-transform: rotate(180deg);}
      }

      @keyframes rotate {
          from {transform: rotate(0deg);}
          to {transform: rotate(180deg);}
      }






    </style>


    <div class="topbar">
      <!-- <p class="flex"></p>
      <locals-button bgrgba="0,0,0,0" id="exitbtn" icon="declinenew" on-tap="toHome"></locals-button> -->

      <p class="flex" on-tap="change"></p>
      <locals-button bgrgba="0,0,0,0" icon="declinenew" on-tap="toHome" small id="exitbtn"></locals-button>

    </div>

    <div class="total">
      <div class="totalpart">
        <div class="balance">
        <template is="dom-if" if="{{!balanceloaded}}">
          <locals-icon class="refresher spinner" icon="refresh1" iconcolor="darkgrey"></locals-icon>
        </template>
        <template is="dom-if" if="{{balanceloaded}}">
          <h1>{{localcoinbalance}}</h1>
          <template is="dom-if" if="{{_is(sizeview,'phone')}}">
          <locals-icon class="localcoinamount" verysmall icon="localcoin" iconcolor="darkgrey"></locals-icon>
          </template>
          <template is="dom-if" if="{{_is(sizeview,'desktop')}}">
          <locals-icon class="localcoinamount" small icon="localcoin" iconcolor="darkgrey"></locals-icon>
          </template>
          <template is="dom-if" if="{{_is(sizeview,'xlarge')}}">
          <locals-icon class="localcoinamount" icon="localcoin" iconcolor="darkgrey"></locals-icon>
          </template>
        <div class="marginbtm">
          <locals-icon class$="refresher {{spinclass}}" icon="refresh1" iconcolor="grey5" small on-tap="refreshBalance"></locals-icon>
        </div>

        </template>
        </div>
        <div class="whitespace"></div>
        <div class="whitespace"></div>
        <template is="dom-if" if="{{collsclosed}}">
          <template is="dom-if" if="{{_is(sizeview,'phone')}}">
            <locals-button small txtbtn txtcolor="blue" on-tap="togglesendcoins"><div class="inbutton">send <locals-icon class="coinbtn" verysmall icon="localcoin" iconcolor="blue"></locals-icon></div></locals-button>
            <locals-button small txtbtn txtcolor="blue" on-tap="togglereceivecoins"><div class="inbutton">receive <locals-icon class="coinbtn" verysmall icon="localcoin" iconcolor="blue"></locals-icon></div></locals-button>
          </template>
          <template is="dom-if" if="{{!_is(sizeview,'phone')}}">
            <locals-button txtbtn txtcolor="blue" on-tap="togglesendcoins"><div class="inbutton">send <locals-icon class="coinbtn" verysmall icon="localcoin" iconcolor="blue"></locals-icon></div></locals-button>
            <locals-button txtbtn txtcolor="blue" on-tap="togglereceivecoins"><div class="inbutton">receive <locals-icon class="coinbtn" verysmall icon="localcoin" iconcolor="blue"></locals-icon></div></locals-button>
          </template>
        </template>
        <iron-collapse id="sendcoins">
        <template is="dom-if" if="{{_is(sendcoinstate,'first')}}">
          <div class="whitespace"></div>
          <locals-input class="sendinput" autofocus bind-value="{{amount}}" label="Amount"></locals-input>
          <locals-input class="sendinput" autofocus bind-value="{{pincode}}" label="To"></locals-input>
          <locals-confirm on-cancel="togglesendcoins" on-confirm="toWaiting" type="next"></locals-confirm>
        </template>

        <template is="dom-if" if="{{_is(sendcoinstate,'second')}}">
          <div class="announce">
          <div class="whitespace"></div>
          <p>Your transaction is being executed.</p>
          <locals-button small icon="declinenew" confirmsmall on-tap="togglesendcoins" class="closebtn"></locals-button>
          </div>
        </template>

        </iron-collapse>
        <iron-collapse id="receivecoins">
          <div class="code">
            <small>Temporary code</small>
            <h2>{{topic}}</h2>
          </div>
          <locals-button small icon="declinenew" confirmsmall on-tap="togglereceivecoins" class="closebtn"></locals-button>
        </iron-collapse>
        <div class="whitespace"></div>
        <div class="whitespace"></div>

      </div>
      <div class="tussenschot"></div>
      <div class="totalpart">
        <p class="temp">Hier komt de historiek van transacties.</p>
      </div>

<!--     <div>
      <h1>E <span>{{ethbalance}}</span></h1>
      <h1>L <span>{{localcoinbalance}}</span></h1>
      <p on-tap="getLocalbalance">Refresh</p>
      <h1>Send funds to another locals user</h1>
      <p>enter the # of the other user</p>
      <locals-input autofocus bind-value="{{pincode}}" label="Pincode" center></locals-input>
      <locals-confirm on-confirm="toWaiting" type="next"></locals-confirm> -->

      <!-- Hier hebben we dan de key van de partner -->
      <!-- <p>TO: <span>{{partnerpubkey}}</span></p>
      <locals-button text on-tap="transfer">verstuur</locals-button> -->
    </div>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'locals-wallet',

      properties: {
        foo: {
          type: String,
          value: 'locals-wallet',
          notify: true
        },

        sizeview: {
          type: String,
          observer: '_sizeview'
        },

        sendcoinstate: {
          type: String,
          value: 'first',
          observer: '_sendcoinstate'

        },

        balanceloaded: {
          type: Boolean,
          value: false
        },

        topic: {
          type: Number,
        },

        collsclosed: {
          type: Boolean,
          value: true
        },


        contractaddr: {
          type: String,
          value: '0xe94a4e5615E5d1BAfbDBc8a221D9b0995f67A752'
        },
        localcoinbalance: {
          type: Number,
          notify: true
        },
        ethbalance: {
          type: Number
        }
      },

      ready: function(){
        this.contractaddr = '0xe94a4e5615E5d1BAfbDBc8a221D9b0995f67A752';
        this.getLocalbalance();
        var self = this;
        window.setInterval(function(){
          self.getLocalbalance();
        }, 5000);
        this.sendcoinstate = 'first';
      },

      attached: function(){
        var self=this;
        this.whisper = document.querySelector('locals-whisperer');
        //debugger;
        this.whisper.addEventListener('message-received', function(e){
          console.log('got pub key: ', e.detail);
          self.handlewhispermessage(e.detail);
          // self.partnerpubkey = e.detail;
          // self.transfer();
        });
      },

      handlewhispermessage: function(m){
        var message = JSON.parse(m.message);
        var whisper = document.querySelector('locals-whisperer');
        switch (message.command){
          case 'requestpubkeyforlocalstransfer':
            this.whisper.whisperpost(m.from, JSON.stringify({
              'command': 'sendpubkey',
              'pubkey' : this.account
            }));
            break;
          case 'sendpubkey':
            console.log('Send localcoin to ',message.pubkey);
            // TODO : hiere transactie uitvoeren dat ge LC stuurt naar message.pubkey...
            this.transfer(this.amount,message.pubkey);
            break;
          default:
            console.log('unknown message',message);
        }
      },

      toWaiting: function(){
        var self = this;
        //debugger;
        this.whisper = document.querySelector('locals-whisperer');
        //this.handler = document.querySelector('locals-verification-validator');
        console.log('wallet: ',this.whisper.topic);
        //debugger;
        this.whisper.whisperpost(this.pincode, JSON.stringify({
                'command': 'requestpubkeyforlocalstransfer',
              }));
        this.state = 'waiting';
      

        this.sendcoinstate = 'second';
      },

      refreshBalance:function() {
        this.spinclass = 'spinonce';
        this.getLocalbalance();
        var self = this;
        setTimeout(function(){
            self.spinclass = '';
        },500)
      },

      getLocalbalance: function(){
        //Get Localcoin token balance
         this.web3wallet = document.querySelector('web3-wallet');
         if (!this.web3wallet || !this.web3wallet.web3){
          return;
         }
        var self = this;

        this.contracturl = this.resolveUrl('../../contracts/localsCointoken.json');
        this.importHref(this.contracturl, function(e) {
          this.contractjson = JSON.parse(e.target.import.body.innerText);

          var MyContract = self.web3wallet.web3.eth.contract(self.contractjson.abi);
          var myContractInstance = MyContract.at(self.contractaddr);


        var account = this.fixaddress(this.account);
        var coinbalance = myContractInstance.balanceOf(account);
        this.localcoinbalance = coinbalance / 100;
        // console.log('localcoinbalance: ', coinbalance);
        this.balanceloaded = true;
        this.fire('balance-loaded');
        });
      },

      transfer: function(amount,pubkey){
        debugger;
        // we gaan dan wat geld versjassen
        this.web3wallet = document.querySelector('web3-wallet');
        //this.amount = 1;
        var self = this;

        this.contracturl = this.resolveUrl('../../contracts/localsCointoken.json');
        this.importHref(this.contracturl, function(e) {
          this.contractjson = JSON.parse(e.target.import.body.innerText);
             self.web3wallet.web3.eth.getGasPrice(function(err, result){
            var gasPrice = result.toNumber(10);
          console.log('gasprice: ', gasPrice);

          var MyContract = self.web3wallet.web3.eth.contract(self.contractjson.abi);
          var myContractInstance = MyContract.at(self.contractaddr);
            console.log('doing transfer to: ', self.partnerpubkey, 'from: ', self.web3wallet.account);
            myContractInstance.transfer.sendTransaction(pubkey, amount, {
              from: self.fixaddress(self.web3wallet.account),
              gasPrice: gasPrice,
              gasLimit: 3000000,
              gas: 2000000
            }, function(err, result){
              console.log(err, result);
              var coinbalance = myContractInstance.balanceOf(self.fixaddress(self.web3wallet.account));
                self.localcoinbalance = coinbalance;
            });

          });
          //this.web3.send(this.partnerpubkey, this.amount);
        });
      },

    toHome: function() {
      this.fire('to-home');
    },

    _sizeview: function(){
      switch(this.sizeview) {
          case 'phone':
              this.customStyle['--balance-h1'] = '40px';
              this.customStyle['--balance-lineheight'] = '52px';
              this.customStyle['--code-h2'] = '32px';
              this.customStyle['--code-lineheight'] = '36px';
              this.customStyle['--code-small'] = '10px';
              this.customStyle['--coin-margins'] = '0px 0px 7px 6px';
                this.customStyle['--topbar-height'] = '100px';
              this.updateStyles();
              break;
          case 'desktop':
              this.customStyle['--balance-h1'] = '60px';
              this.customStyle['--balance-lineheight'] = '78px';
              this.customStyle['--code-h2'] = '44px';
              this.customStyle['--code-lineheight'] = '50px';
              this.customStyle['--code-small'] = '12px';
              this.customStyle['--coin-margins'] = '0px 0px 10px 6px';
                this.customStyle['--topbar-height'] = '100px';
              this.updateStyles();
              break;
          case 'xlarge':
              this.customStyle['--balance-h1'] = '120px';
              this.customStyle['--balance-lineheight'] = '152px';
              this.customStyle['--code-h2'] = '98px';
              this.customStyle['--code-lineheight'] = '104px';
              this.customStyle['--code-small'] = '24px';
              this.customStyle['--coin-margins'] = '0px 0px 20px 6px';
                this.customStyle['--topbar-height'] = '100px';
              this.updateStyles();
              break;
          default:
          console.log("!!! ** Niks");
      }
    },


    _is: function(a, b) {
      if (b === undefined){
        b = true;
      }
      //console.log(a ,'(',typeof a,') is',b,'(',typeof b,') they are equal for ==',a == b,', they are equal for ===',a === b);
      return a === b;
    },

      togglesendcoins: function() {
        var sendcoins = document.querySelector('#sendcoins');
        sendcoins.toggle();
        this.collsclosed=!this.collsclosed;
        this.sendcoinstate = 'first';
      },

      togglereceivecoins: function() {
        // this.whisper = document.querySelector('locals-whisperer');
        // this.topic = this.whisper.topic;
        // console.log("******** topic in wallet: ****",this.topic)

        var receivecoins = document.querySelector('#receivecoins');
        receivecoins.toggle();
        this.collsclosed=!this.collsclosed;
      },


      _sendcoinstate: function(){
        // console.log('********************* !!!! SENCOINSTATE', this.sendcoinstate);
      },



      fixaddress: function(address) {
      function strStartsWith(str, prefix) {
        return str.indexOf(prefix) === 0;
      }

      if (!strStartsWith(address, '0x')) {
        return ('0x' + address);
      }
      return address;
    }

    });
  })();
  </script>
</dom-module>
